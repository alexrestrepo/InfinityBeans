<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 700">
  <!-- Background -->
  <rect width="950" height="700" fill="#f8fafc"/>

  <!-- Title -->
  <text x="475" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="20" font-weight="bold" fill="#1e293b">Network Action Queue</text>
  <text x="475" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#64748b">from network.c, vbl.c — deterministic peer-to-peer synchronization</text>

  <!-- Peer-to-peer topology (top left) -->
  <g transform="translate(50, 80)">
    <text x="130" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#2563eb">Full Mesh Topology</text>

    <g transform="translate(30, 20)">
      <!-- Players as circles -->
      <circle cx="100" cy="20" r="25" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
      <text x="100" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#1e40af">P1</text>

      <circle cx="180" cy="80" r="25" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
      <text x="180" y="85" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#166534">P2</text>

      <circle cx="100" cy="140" r="25" fill="#fef3c7" stroke="#d97706" stroke-width="2"/>
      <text x="100" y="145" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#92400e">P3</text>

      <circle cx="20" cy="80" r="25" fill="#f3e8ff" stroke="#9333ea" stroke-width="2"/>
      <text x="20" y="85" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#7e22ce">P4</text>

      <!-- Connection lines (all to all) -->
      <line x1="75" y1="30" x2="155" y2="60" stroke="#94a3b8" stroke-width="1"/>
      <line x1="100" y1="45" x2="100" y2="115" stroke="#94a3b8" stroke-width="1"/>
      <line x1="75" y1="30" x2="35" y2="58" stroke="#94a3b8" stroke-width="1"/>
      <line x1="155" y1="100" x2="125" y2="125" stroke="#94a3b8" stroke-width="1"/>
      <line x1="45" y1="90" x2="75" y2="130" stroke="#94a3b8" stroke-width="1"/>
      <line x1="45" y1="70" x2="155" y2="70" stroke="#94a3b8" stroke-width="1"/>
    </g>

    <text x="130" y="195" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Every player connects to every other</text>
    <text x="130" y="208" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">n(n-1)/2 = 6 connections for 4 players</text>
  </g>

  <!-- Action flags structure (top right) -->
  <g transform="translate(320, 80)">
    <rect x="0" y="0" width="580" height="130" rx="8" fill="#f0fdf4" stroke="#16a34a" stroke-width="2"/>
    <text x="290" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#166534">32-bit Action Flags (4 bytes per player per tick)</text>

    <!-- Bit layout -->
    <g transform="translate(20, 40)">
      <rect x="0" y="0" width="130" height="35" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
      <text x="65" y="15" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="#1e40af">Yaw (7 bits)</text>
      <text x="65" y="28" text-anchor="middle" font-family="monospace" font-size="8" fill="#3b82f6">bits 0-6</text>

      <rect x="130" y="0" width="100" height="35" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
      <text x="180" y="15" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="#166534">Pitch (5 bits)</text>
      <text x="180" y="28" text-anchor="middle" font-family="monospace" font-size="8" fill="#16a34a">bits 14-18</text>

      <rect x="230" y="0" width="150" height="35" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
      <text x="305" y="15" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="#92400e">Movement Flags</text>
      <text x="305" y="28" text-anchor="middle" font-family="monospace" font-size="8" fill="#d97706">forward, back, strafe, run</text>

      <rect x="380" y="0" width="150" height="35" fill="#fecaca" stroke="#dc2626" stroke-width="1"/>
      <text x="455" y="15" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" font-weight="600" fill="#991b1b">Action Flags</text>
      <text x="455" y="28" text-anchor="middle" font-family="monospace" font-size="8" fill="#dc2626">fire, action, weapon cycle</text>
    </g>

    <text x="20" y="100" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Bandwidth: 4 players × 4 bytes × 30 ticks/sec = 480 bytes/sec</text>
    <text x="20" y="115" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Compare: Modern games send 10-100 KB/sec per player!</text>
  </g>

  <!-- Synchronization timeline (middle) -->
  <g transform="translate(50, 310)">
    <text x="425" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#475569">Synchronization Timeline (All Players Must Wait)</text>

    <g transform="translate(0, 20)">
      <!-- Timeline axis -->
      <line x1="0" y1="0" x2="850" y2="0" stroke="#94a3b8" stroke-width="2"/>
      <text x="870" y="5" font-family="system-ui, sans-serif" font-size="10" fill="#64748b">time →</text>

      <!-- Tick markers -->
      <line x1="100" y1="-10" x2="100" y2="10" stroke="#475569" stroke-width="2"/>
      <text x="100" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#475569">Tick N</text>

      <line x1="400" y1="-10" x2="400" y2="10" stroke="#475569" stroke-width="2"/>
      <text x="400" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#475569">Tick N+1</text>

      <line x1="700" y1="-10" x2="700" y2="10" stroke="#475569" stroke-width="2"/>
      <text x="700" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#475569">Tick N+2</text>

      <!-- Player rows -->
      <!-- P1 -->
      <text x="0" y="55" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">P1:</text>
      <rect x="100" y="42" width="50" height="20" rx="3" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
      <text x="125" y="56" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#1e40af">Input</text>
      <rect x="150" y="42" width="80" height="20" rx="3" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
      <text x="190" y="56" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#4338ca">Wait</text>
      <rect x="230" y="42" width="70" height="20" rx="3" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
      <text x="265" y="56" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#166534">Simulate</text>
      <rect x="300" y="42" width="100" height="20" rx="3" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
      <text x="350" y="56" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#92400e">Render</text>

      <!-- P2 -->
      <text x="0" y="80" font-family="system-ui, sans-serif" font-size="10" fill="#166534">P2:</text>
      <rect x="100" y="67" width="50" height="20" rx="3" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
      <text x="125" y="81" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#166534">Input</text>
      <rect x="150" y="67" width="80" height="20" rx="3" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
      <text x="190" y="81" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#4338ca">Wait</text>
      <rect x="230" y="67" width="70" height="20" rx="3" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
      <text x="265" y="81" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#166534">Simulate</text>
      <rect x="300" y="67" width="100" height="20" rx="3" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
      <text x="350" y="81" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#92400e">Render</text>

      <!-- P3 (slow) -->
      <text x="0" y="105" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">P3:</text>
      <rect x="100" y="92" width="50" height="20" rx="3" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
      <text x="125" y="106" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#92400e">Input</text>
      <rect x="150" y="92" width="80" height="20" rx="3" fill="#fecaca" stroke="#dc2626" stroke-width="1"/>
      <text x="190" y="106" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#991b1b">SLOW!</text>
      <rect x="230" y="92" width="70" height="20" rx="3" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
      <text x="265" y="106" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#166534">Simulate</text>
      <rect x="300" y="92" width="100" height="20" rx="3" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
      <text x="350" y="106" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#92400e">Render</text>

      <!-- Annotation -->
      <line x1="230" y1="40" x2="230" y2="120" stroke="#dc2626" stroke-width="1" stroke-dasharray="4,2"/>
      <text x="235" y="135" font-family="system-ui, sans-serif" font-size="9" fill="#dc2626">All wait for slowest player</text>
    </g>
  </g>

  <!-- Action queue buffer (bottom left) -->
  <g transform="translate(50, 480)">
    <rect x="0" y="0" width="400" height="180" rx="8" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
    <text x="200" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#1e40af">Action Queue Buffer</text>

    <text x="20" y="45" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">Current Tick: 100</text>

    <!-- Queue visualization -->
    <g transform="translate(20, 55)">
      <rect x="0" y="0" width="45" height="35" fill="#94a3b8" stroke="#475569" stroke-width="1"/>
      <text x="22" y="15" text-anchor="middle" font-family="monospace" font-size="9" fill="white">98</text>
      <text x="22" y="28" text-anchor="middle" font-family="system-ui, sans-serif" font-size="7" fill="white">past</text>

      <rect x="45" y="0" width="45" height="35" fill="#94a3b8" stroke="#475569" stroke-width="1"/>
      <text x="67" y="15" text-anchor="middle" font-family="monospace" font-size="9" fill="white">99</text>
      <text x="67" y="28" text-anchor="middle" font-family="system-ui, sans-serif" font-size="7" fill="white">past</text>

      <rect x="90" y="0" width="45" height="35" fill="#16a34a" stroke="#166534" stroke-width="2"/>
      <text x="112" y="15" text-anchor="middle" font-family="monospace" font-size="9" fill="white">100</text>
      <text x="112" y="28" text-anchor="middle" font-family="system-ui, sans-serif" font-size="7" fill="white">NOW</text>

      <rect x="135" y="0" width="45" height="35" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
      <text x="157" y="15" text-anchor="middle" font-family="monospace" font-size="9" fill="#1e40af">101</text>
      <text x="157" y="28" text-anchor="middle" font-family="system-ui, sans-serif" font-size="7" fill="#2563eb">buffer</text>

      <rect x="180" y="0" width="45" height="35" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
      <text x="202" y="15" text-anchor="middle" font-family="monospace" font-size="9" fill="#1e40af">102</text>
      <text x="202" y="28" text-anchor="middle" font-family="system-ui, sans-serif" font-size="7" fill="#2563eb">buffer</text>

      <rect x="225" y="0" width="45" height="35" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
      <text x="247" y="15" text-anchor="middle" font-family="monospace" font-size="9" fill="#1e40af">103</text>
      <text x="247" y="28" text-anchor="middle" font-family="system-ui, sans-serif" font-size="7" fill="#2563eb">buffer</text>

      <rect x="270" y="0" width="45" height="35" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
      <text x="292" y="15" text-anchor="middle" font-family="monospace" font-size="9" fill="#64748b">...</text>
    </g>

    <text x="20" y="115" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">Buffer size: 30-60 ticks (1-2 seconds)</text>
    <text x="20" y="132" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">Late packet → insert at correct tick position</text>
    <text x="20" y="149" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">Very late (past tick) → DESYNC DETECTED!</text>
    <text x="20" y="166" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Game pauses or disconnects desynced player</text>
  </g>

  <!-- Determinism requirements (bottom right) -->
  <g transform="translate(480, 480)">
    <rect x="0" y="0" width="420" height="180" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
    <text x="210" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#991b1b">Determinism Requirements</text>

    <text x="20" y="48" font-family="system-ui, sans-serif" font-size="10" fill="#991b1b">Same inputs + same code = same state (on ALL machines)</text>

    <g transform="translate(20, 60)">
      <text x="0" y="12" font-family="system-ui, sans-serif" font-size="10" fill="#166534">✓ Fixed-point math (no floating-point)</text>
      <text x="0" y="28" font-family="system-ui, sans-serif" font-size="10" fill="#166534">✓ Fixed timestep (exactly 30 ticks/sec)</text>
      <text x="0" y="44" font-family="system-ui, sans-serif" font-size="10" fill="#166534">✓ Synchronized random seed</text>
      <text x="0" y="60" font-family="system-ui, sans-serif" font-size="10" fill="#166534">✓ Single-threaded simulation</text>
      <text x="0" y="76" font-family="system-ui, sans-serif" font-size="10" fill="#166534">✓ Identical code on all platforms</text>
    </g>

    <text x="20" y="155" font-family="monospace" font-size="9" fill="#991b1b">// WRONG: float v = distance / time;</text>
    <text x="20" y="170" font-family="monospace" font-size="9" fill="#166534">// RIGHT: fixed v = FIXED_DIV(distance, time);</text>
  </g>

  <!-- Checksum validation (middle right) -->
  <g transform="translate(620, 230)">
    <rect x="0" y="0" width="280" height="70" rx="6" fill="#f1f5f9" stroke="#64748b" stroke-width="1"/>
    <text x="140" y="18" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#475569">Checksum Validation</text>
    <text x="15" y="38" font-family="system-ui, sans-serif" font-size="9" fill="#475569">Every 10 ticks: CRC32(player_positions)</text>
    <text x="15" y="52" font-family="system-ui, sans-serif" font-size="9" fill="#475569">Mismatch → desync detected → pause/disconnect</text>
    <text x="15" y="66" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Catches floating-point errors, race conditions</text>
  </g>

  <!-- Source reference -->
  <text x="475" y="690" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">Source: network.c, vbl.c, player.h — action queue and synchronization</text>
</svg>
