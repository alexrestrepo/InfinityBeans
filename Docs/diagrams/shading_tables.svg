<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 700">
  <!-- Background -->
  <rect width="950" height="700" fill="#f8fafc"/>

  <!-- Title -->
  <text x="475" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="20" font-weight="bold" fill="#1e293b">Pre-Computed Shading Tables</text>
  <text x="475" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#64748b">from scottish_textures.c, shapes.c — fast lighting via lookup tables</text>

  <!-- The problem (top left) -->
  <g transform="translate(50, 80)">
    <rect x="0" y="0" width="280" height="120" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
    <text x="140" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#991b1b">The Problem (1995)</text>

    <text x="15" y="48" font-family="system-ui, sans-serif" font-size="10" fill="#991b1b">Per-pixel lighting calculation:</text>
    <text x="20" y="65" font-family="monospace" font-size="9" fill="#dc2626">lit_color = base_color × light_level</text>
    <text x="20" y="80" font-family="monospace" font-size="9" fill="#dc2626">// Multiply per pixel = SLOW!</text>

    <text x="15" y="100" font-family="system-ui, sans-serif" font-size="10" fill="#991b1b">At 100,000 pixels/frame × 30 FPS:</text>
    <text x="15" y="115" font-family="system-ui, sans-serif" font-size="10" fill="#991b1b">= 3 million multiplies/second</text>
  </g>

  <!-- The solution (top center) -->
  <g transform="translate(350, 80)">
    <rect x="0" y="0" width="280" height="120" rx="8" fill="#f0fdf4" stroke="#16a34a" stroke-width="2"/>
    <text x="140" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#166534">The Solution</text>

    <text x="15" y="48" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Pre-compute ALL possible results:</text>
    <text x="20" y="65" font-family="monospace" font-size="9" fill="#16a34a">shading_table[light][color] = result</text>
    <text x="20" y="80" font-family="monospace" font-size="9" fill="#16a34a">// Single array lookup = FAST!</text>

    <text x="15" y="100" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Replace multiply with table lookup:</text>
    <text x="15" y="115" font-family="system-ui, sans-serif" font-size="10" fill="#166534">lit_pixel = table[texel] (one memory read)</text>
  </g>

  <!-- Memory cost (top right) -->
  <g transform="translate(650, 80)">
    <rect x="0" y="0" width="250" height="120" rx="8" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
    <text x="125" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#1e40af">Memory Cost</text>

    <text x="15" y="48" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">8-bit mode:</text>
    <text x="20" y="65" font-family="monospace" font-size="9" fill="#3b82f6">32 tables × 256 colors = 8 KB</text>

    <text x="15" y="88" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">16/32-bit mode:</text>
    <text x="20" y="105" font-family="monospace" font-size="9" fill="#3b82f6">64 tables × 256 entries × 2/4 bytes</text>
    <text x="20" y="118" font-family="monospace" font-size="9" fill="#3b82f6">= 32KB (16-bit) or 64KB (32-bit)</text>
  </g>

  <!-- Visual diagram of shading table structure -->
  <g transform="translate(50, 220)">
    <text x="425" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#475569">Shading Table Structure</text>

    <!-- Table visualization -->
    <g transform="translate(0, 20)">
      <!-- Light level axis label -->
      <text x="-10" y="90" text-anchor="end" font-family="system-ui, sans-serif" font-size="11" fill="#475569" transform="rotate(-90, -10, 90)">Light Level (0-31)</text>

      <!-- Color index axis label -->
      <text x="200" y="-5" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#475569">Palette Color Index (0-255)</text>

      <!-- Grid -->
      <rect x="30" y="10" width="340" height="160" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>

      <!-- Light level rows -->
      <rect x="30" y="10" width="340" height="20" fill="#1e293b"/>
      <text x="10" y="24" font-family="monospace" font-size="8" fill="#475569">31</text>
      <text x="200" y="24" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="white">Full Brightness</text>

      <rect x="30" y="50" width="340" height="20" fill="#374151"/>
      <text x="10" y="64" font-family="monospace" font-size="8" fill="#475569">20</text>

      <rect x="30" y="90" width="340" height="20" fill="#6b7280"/>
      <text x="10" y="104" font-family="monospace" font-size="8" fill="#475569">16</text>
      <text x="200" y="104" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="white">Half Brightness</text>

      <rect x="30" y="130" width="340" height="20" fill="#9ca3af"/>
      <text x="10" y="144" font-family="monospace" font-size="8" fill="#475569">8</text>

      <rect x="30" y="150" width="340" height="20" fill="#d1d5db"/>
      <text x="10" y="164" font-family="monospace" font-size="8" fill="#475569">0</text>
      <text x="200" y="164" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#1e293b">Darkness</text>

      <!-- Color columns example -->
      <rect x="50" y="10" width="30" height="160" fill="#dc2626" fill-opacity="0.3" stroke="#dc2626" stroke-width="1"/>
      <text x="65" y="185" text-anchor="middle" font-family="monospace" font-size="8" fill="#dc2626">RED</text>

      <rect x="120" y="10" width="30" height="160" fill="#16a34a" fill-opacity="0.3" stroke="#16a34a" stroke-width="1"/>
      <text x="135" y="185" text-anchor="middle" font-family="monospace" font-size="8" fill="#16a34a">GRN</text>

      <rect x="190" y="10" width="30" height="160" fill="#2563eb" fill-opacity="0.3" stroke="#2563eb" stroke-width="1"/>
      <text x="205" y="185" text-anchor="middle" font-family="monospace" font-size="8" fill="#2563eb">BLU</text>

      <text x="280" y="100" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">...</text>

      <rect x="310" y="10" width="30" height="160" fill="#fbbf24" fill-opacity="0.3" stroke="#d97706" stroke-width="1"/>
      <text x="325" y="185" text-anchor="middle" font-family="monospace" font-size="8" fill="#d97706">255</text>
    </g>

    <!-- Example lookup -->
    <g transform="translate(420, 20)">
      <rect x="0" y="0" width="430" height="170" rx="6" fill="#fef3c7" stroke="#d97706" stroke-width="2"/>
      <text x="215" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#92400e">Example: Rendering a Red Texel</text>

      <!-- Bright example -->
      <g transform="translate(20, 40)">
        <rect x="0" y="0" width="25" height="25" fill="#dc2626"/>
        <text x="35" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">texel = 45 (red)</text>
        <text x="170" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">light = 31 (bright)</text>

        <line x1="280" y1="12" x2="310" y2="12" stroke="#d97706" stroke-width="2"/>
        <polygon points="315,12 305,7 305,17" fill="#d97706"/>

        <rect x="320" y="0" width="25" height="25" fill="#dc2626"/>
        <text x="355" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">= bright red</text>
      </g>

      <!-- Medium example -->
      <g transform="translate(20, 75)">
        <rect x="0" y="0" width="25" height="25" fill="#dc2626"/>
        <text x="35" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">texel = 45 (red)</text>
        <text x="170" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">light = 16 (half)</text>

        <line x1="280" y1="12" x2="310" y2="12" stroke="#d97706" stroke-width="2"/>
        <polygon points="315,12 305,7 305,17" fill="#d97706"/>

        <rect x="320" y="0" width="25" height="25" fill="#991b1b"/>
        <text x="355" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">= medium red</text>
      </g>

      <!-- Dark example -->
      <g transform="translate(20, 110)">
        <rect x="0" y="0" width="25" height="25" fill="#dc2626"/>
        <text x="35" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">texel = 45 (red)</text>
        <text x="170" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">light = 4 (dark)</text>

        <line x1="280" y1="12" x2="310" y2="12" stroke="#d97706" stroke-width="2"/>
        <polygon points="315,12 305,7 305,17" fill="#d97706"/>

        <rect x="320" y="0" width="25" height="25" fill="#450a0a"/>
        <text x="355" y="18" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">= dark red</text>
      </g>

      <text x="215" y="160" text-anchor="middle" font-family="monospace" font-size="9" fill="#92400e">pixel = shading_table[texel]; // Just one lookup!</text>
    </g>
  </g>

  <!-- Inner loop code -->
  <g transform="translate(50, 440)">
    <rect x="0" y="0" width="420" height="160" rx="8" fill="#f1f5f9" stroke="#64748b" stroke-width="2"/>
    <text x="210" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#475569">Texture Mapping Inner Loop</text>

    <text x="15" y="48" font-family="monospace" font-size="9" fill="#475569">// Shading table selected BEFORE inner loop</text>
    <text x="15" y="63" font-family="monospace" font-size="9" fill="#475569">// based on polygon/column distance</text>
    <text x="15" y="78" font-family="monospace" font-size="9" fill="#16a34a">void *shading_table = tables[light_level];</text>

    <text x="15" y="100" font-family="monospace" font-size="9" fill="#475569">// Inner loop - runs millions of times/sec</text>
    <text x="15" y="115" font-family="monospace" font-size="9" fill="#2563eb">while (count--) {</text>
    <text x="25" y="130" font-family="monospace" font-size="9" fill="#2563eb">  texel = texture[source_y &gt;&gt; 16];</text>
    <text x="25" y="145" font-family="monospace" font-size="9" fill="#dc2626">  *dest++ = shading_table[texel]; // THE KEY LINE</text>
    <text x="15" y="160" font-family="monospace" font-size="9" fill="#2563eb">}</text>
  </g>

  <!-- How tables are built -->
  <g transform="translate(490, 440)">
    <rect x="0" y="0" width="410" height="160" rx="8" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
    <text x="205" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#1e40af">Building Shading Tables</text>

    <text x="15" y="48" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">At collection load time (shapes.c):</text>

    <text x="15" y="70" font-family="monospace" font-size="9" fill="#3b82f6">for (light = 0; light &lt; 32; light++) {</text>
    <text x="25" y="85" font-family="monospace" font-size="9" fill="#3b82f6">  intensity = light / 31.0;  // 0.0 to 1.0</text>
    <text x="25" y="100" font-family="monospace" font-size="9" fill="#3b82f6">  for (color = 0; color &lt; 256; color++) {</text>
    <text x="35" y="115" font-family="monospace" font-size="9" fill="#3b82f6">    r = palette[color].r * intensity;</text>
    <text x="35" y="130" font-family="monospace" font-size="9" fill="#3b82f6">    g = palette[color].g * intensity;</text>
    <text x="35" y="145" font-family="monospace" font-size="9" fill="#3b82f6">    b = palette[color].b * intensity;</text>
    <text x="35" y="160" font-family="monospace" font-size="9" fill="#3b82f6">    table[light][color] = MAKE_PIXEL(r,g,b);</text>
  </g>

  <!-- Performance comparison -->
  <g transform="translate(50, 620)">
    <rect x="0" y="0" width="850" height="55" rx="6" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
    <text x="425" y="20" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#166534">Performance Gain</text>

    <text x="50" y="42" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Without tables: MUL + MUL + MUL + CLAMP per pixel ≈ 20 cycles</text>
    <text x="480" y="42" font-family="system-ui, sans-serif" font-size="10" fill="#166534">With tables: LOAD (1 memory read) ≈ 2 cycles = 10× faster!</text>
  </g>

  <!-- Source reference -->
  <text x="475" y="695" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">Source: scottish_textures.c:107-157 (_horizontal/_vertical_polygon_line_data), shapes.c (build_shading_tables)</text>
</svg>
