<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 750">
  <!-- Background -->
  <rect width="1000" height="750" fill="#f8fafc"/>

  <!-- Title -->
  <text x="500" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="20" font-weight="bold" fill="#1e293b">Monster AI State Machine</text>
  <text x="500" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#64748b">Two-layer system: Action States + Target Mode</text>

  <!-- ACTION STATES (left side) -->
  <g transform="translate(30, 70)">
    <text x="220" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="16" font-weight="bold" fill="#0369a1">Action States</text>
    <text x="220" y="18" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#64748b">(What the monster is physically doing)</text>

    <!-- _stationary -->
    <rect x="150" y="40" width="140" height="40" rx="20" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
    <text x="220" y="65" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#0369a1">_stationary</text>

    <!-- Arrow to moving -->
    <line x1="220" y1="80" x2="220" y2="115" stroke="#475569" stroke-width="2"/>
    <polygon points="220,120 215,110 225,110" fill="#475569"/>
    <text x="230" y="100" font-family="system-ui, sans-serif" font-size="9" fill="#475569">path found</text>

    <!-- _moving -->
    <rect x="150" y="120" width="140" height="40" rx="20" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
    <text x="220" y="145" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#166534">_moving</text>

    <!-- Arrow back to stationary (curved path) -->
    <path d="M 150,140 C 100,140 100,60 150,60" stroke="#475569" stroke-width="2" fill="none"/>
    <polygon points="150,60 140,55 140,65" fill="#475569"/>
    <text x="85" y="105" font-family="system-ui, sans-serif" font-size="9" fill="#475569">no path</text>

    <!-- Fork lines to attacks -->
    <line x1="220" y1="160" x2="220" y2="190" stroke="#475569" stroke-width="2"/>
    <line x1="120" y1="190" x2="320" y2="190" stroke="#475569" stroke-width="2"/>
    <line x1="120" y1="190" x2="120" y2="220" stroke="#475569" stroke-width="2"/>
    <polygon points="120,225 115,215 125,215" fill="#475569"/>
    <line x1="320" y1="190" x2="320" y2="220" stroke="#475569" stroke-width="2"/>
    <polygon points="320,225 315,215 325,215" fill="#475569"/>
    <text x="170" y="185" font-family="system-ui, sans-serif" font-size="9" fill="#475569">in range</text>

    <!-- _attacking_close -->
    <rect x="40" y="225" width="160" height="40" rx="20" fill="#fef3c7" stroke="#d97706" stroke-width="2"/>
    <text x="120" y="250" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#92400e">_attacking_close</text>
    <text x="120" y="280" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#92400e">(melee)</text>

    <!-- _attacking_far -->
    <rect x="240" y="225" width="160" height="40" rx="20" fill="#fef3c7" stroke="#d97706" stroke-width="2"/>
    <text x="320" y="250" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#92400e">_attacking_far</text>
    <text x="320" y="280" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#92400e">(ranged)</text>

    <!-- Arrows to waiting -->
    <line x1="120" y1="265" x2="120" y2="295" stroke="#475569" stroke-width="2"/>
    <line x1="120" y1="295" x2="320" y2="295" stroke="#475569" stroke-width="2"/>
    <line x1="320" y1="265" x2="320" y2="295" stroke="#475569" stroke-width="2"/>
    <line x1="220" y1="295" x2="220" y2="315" stroke="#475569" stroke-width="2"/>
    <polygon points="220,320 215,310 225,310" fill="#475569"/>
    <text x="170" y="310" font-family="system-ui, sans-serif" font-size="9" fill="#475569">attack done</text>

    <!-- _waiting_to_attack_again -->
    <rect x="120" y="320" width="200" height="40" rx="20" fill="#f3e8ff" stroke="#9333ea" stroke-width="2"/>
    <text x="220" y="345" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#7e22ce">_waiting_to_attack_again</text>

    <!-- Arrow back to moving (curved) -->
    <path d="M 320,340 C 400,340 400,140 290,140" stroke="#475569" stroke-width="2" fill="none"/>
    <polygon points="290,140 300,135 300,145" fill="#475569"/>
    <text x="370" y="240" font-family="system-ui, sans-serif" font-size="9" fill="#475569">cooldown</text>
    <text x="370" y="252" font-family="system-ui, sans-serif" font-size="9" fill="#475569">done</text>

    <!-- DAMAGE INTERRUPT (red box) -->
    <rect x="40" y="400" width="360" height="80" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
    <text x="220" y="425" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#991b1b">Damage Interrupt</text>
    <text x="220" y="445" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">From ANY combat state: _being_hit</text>
    <text x="220" y="465" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">After stun animation: _moving</text>

    <!-- _being_hit state -->
    <rect x="150" y="500" width="140" height="40" rx="20" fill="#fecaca" stroke="#dc2626" stroke-width="2"/>
    <text x="220" y="525" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#991b1b">_being_hit</text>

    <!-- Death states -->
    <g transform="translate(0, 560)">
      <text x="220" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#64748b">Death States (lethal damage):</text>
      <rect x="20" y="10" width="100" height="30" rx="6" fill="#374151" stroke="#1f2937" stroke-width="1"/>
      <text x="70" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="white">_dying_soft</text>
      <rect x="140" y="10" width="100" height="30" rx="6" fill="#374151" stroke="#1f2937" stroke-width="1"/>
      <text x="190" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="white">_dying_hard</text>
      <rect x="260" y="10" width="110" height="30" rx="6" fill="#374151" stroke="#1f2937" stroke-width="1"/>
      <text x="315" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="white">_dying_flaming</text>
    </g>
  </g>

  <!-- MODE SYSTEM (right side) -->
  <g transform="translate(520, 70)">
    <text x="220" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="16" font-weight="bold" fill="#7c3aed">Target Mode</text>
    <text x="220" y="18" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#64748b">(Target lock status - independent of action)</text>

    <!-- _unlocked -->
    <rect x="150" y="40" width="140" height="45" rx="22" fill="#f5f3ff" stroke="#7c3aed" stroke-width="2"/>
    <text x="220" y="60" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#6b21a8">_unlocked</text>
    <text x="220" y="75" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#7c3aed">(no target)</text>

    <!-- Arrow to locked -->
    <line x1="220" y1="85" x2="220" y2="115" stroke="#7c3aed" stroke-width="2"/>
    <polygon points="220,120 215,110 225,110" fill="#7c3aed"/>
    <text x="260" y="105" font-family="system-ui, sans-serif" font-size="9" fill="#7c3aed">target acquired</text>

    <!-- _locked -->
    <rect x="150" y="120" width="140" height="45" rx="22" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
    <text x="220" y="140" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#166534">_locked</text>
    <text x="220" y="155" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#16a34a">(has target in sight)</text>

    <!-- Arrow to losing_lock -->
    <line x1="220" y1="165" x2="220" y2="195" stroke="#7c3aed" stroke-width="2"/>
    <polygon points="220,200 215,190 225,190" fill="#7c3aed"/>
    <text x="260" y="185" font-family="system-ui, sans-serif" font-size="9" fill="#7c3aed">target hidden</text>

    <!-- _losing_lock -->
    <rect x="150" y="200" width="140" height="45" rx="22" fill="#fef9c3" stroke="#ca8a04" stroke-width="2"/>
    <text x="220" y="220" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#a16207">_losing_lock</text>
    <text x="220" y="235" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#ca8a04">(searching)</text>

    <!-- Arrow back to locked (curved) -->
    <path d="M 290,220 C 340,220 340,140 290,140" stroke="#16a34a" stroke-width="2" fill="none"/>
    <polygon points="290,140 300,135 300,145" fill="#16a34a"/>
    <text x="350" y="180" font-family="system-ui, sans-serif" font-size="9" fill="#16a34a">target</text>
    <text x="350" y="192" font-family="system-ui, sans-serif" font-size="9" fill="#16a34a">visible</text>

    <!-- Arrow to lost_lock -->
    <line x1="220" y1="245" x2="220" y2="275" stroke="#7c3aed" stroke-width="2"/>
    <polygon points="220,280 215,270 225,270" fill="#7c3aed"/>
    <text x="260" y="265" font-family="system-ui, sans-serif" font-size="9" fill="#7c3aed">intelligence</text>
    <text x="260" y="277" font-family="system-ui, sans-serif" font-size="9" fill="#7c3aed">depleted</text>

    <!-- _lost_lock -->
    <rect x="150" y="280" width="140" height="45" rx="22" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
    <text x="220" y="300" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#991b1b">_lost_lock</text>
    <text x="220" y="315" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#dc2626">(going to last known)</text>

    <!-- Arrow to unlocked (curved path on left) -->
    <path d="M 150,300 C 80,300 80,60 150,60" stroke="#7c3aed" stroke-width="2" fill="none"/>
    <polygon points="150,60 140,55 140,65" fill="#7c3aed"/>
    <text x="60" y="180" font-family="system-ui, sans-serif" font-size="9" fill="#7c3aed">path</text>
    <text x="60" y="192" font-family="system-ui, sans-serif" font-size="9" fill="#7c3aed">exhausted</text>

    <!-- Arrow back to locked from lost_lock (outer curve) -->
    <path d="M 290,300 C 380,300 380,140 290,140" stroke="#16a34a" stroke-width="2" fill="none"/>
    <text x="400" y="220" font-family="system-ui, sans-serif" font-size="9" fill="#16a34a">target visible</text>

    <!-- Intelligence explanation -->
    <rect x="40" y="360" width="380" height="120" rx="8" fill="#faf5ff" stroke="#7c3aed" stroke-width="2"/>
    <text x="230" y="385" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#6b21a8">Intelligence (Lock Persistence)</text>

    <text x="60" y="410" font-family="system-ui, sans-serif" font-size="11" fill="#7c3aed">Higher intelligence = more polygon changes before losing lock:</text>

    <text x="80" y="435" font-family="monospace" font-size="10" fill="#6b21a8">_intelligence_low     = 2 changes</text>
    <text x="80" y="452" font-family="monospace" font-size="10" fill="#6b21a8">_intelligence_average = 3 changes</text>
    <text x="80" y="469" font-family="monospace" font-size="10" fill="#6b21a8">_intelligence_high    = 8 changes</text>

    <!-- Running mode (civilians) -->
    <rect x="150" y="500" width="140" height="45" rx="22" fill="#f1f5f9" stroke="#64748b" stroke-width="2"/>
    <text x="220" y="520" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#475569">_running</text>
    <text x="220" y="535" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">(fleeing - civilians)</text>
  </g>

  <!-- Key insight -->
  <g transform="translate(520, 620)">
    <rect x="40" y="0" width="380" height="80" rx="8" fill="#f0fdf4" stroke="#16a34a" stroke-width="2"/>
    <text x="230" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#166534">Why Two Layers?</text>
    <text x="60" y="48" font-family="system-ui, sans-serif" font-size="11" fill="#166534">Monster can be _moving + _locked (walking toward visible target)</text>
    <text x="60" y="66" font-family="system-ui, sans-serif" font-size="11" fill="#166534">Monster can be _attacking + _losing_lock (shooting at last known)</text>
  </g>

  <!-- Source reference -->
  <text x="500" y="735" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">Source: monsters.c:318-447, 1011-1042</text>
</svg>
