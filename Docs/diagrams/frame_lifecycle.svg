<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 700">
  <!-- Background -->
  <rect width="950" height="700" fill="#f8fafc"/>

  <!-- Title -->
  <text x="475" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="20" font-weight="bold" fill="#1e293b">Life of a Frame — Complete Render Pipeline</text>
  <text x="475" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#64748b">from render.c — portal-based visibility and rendering</text>

  <!-- Main pipeline (vertical flow) -->
  <g transform="translate(50, 70)">
    <!-- Stage 1: Setup -->
    <rect x="0" y="0" width="200" height="80" rx="8" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
    <text x="100" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#1e40af">1. SETUP</text>
    <text x="100" y="42" text-anchor="middle" font-family="monospace" font-size="9" fill="#1e40af">initialize_view()</text>
    <text x="15" y="58" font-family="system-ui, sans-serif" font-size="9" fill="#3b82f6">• Set view origin (player pos)</text>
    <text x="15" y="71" font-family="system-ui, sans-serif" font-size="9" fill="#3b82f6">• Calculate view cone bounds</text>

    <!-- Arrow -->
    <line x1="100" y1="80" x2="100" y2="95" stroke="#475569" stroke-width="2"/>
    <polygon points="100,100 95,90 105,90" fill="#475569"/>

    <!-- Stage 2: Portal Discovery -->
    <rect x="0" y="105" width="200" height="80" rx="8" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
    <text x="100" y="130" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#166534">2. PORTAL DISCOVERY</text>
    <text x="100" y="147" text-anchor="middle" font-family="monospace" font-size="9" fill="#166534">build_render_tree()</text>
    <text x="15" y="163" font-family="system-ui, sans-serif" font-size="9" fill="#16a34a">• Flood fill from player polygon</text>
    <text x="15" y="176" font-family="system-ui, sans-serif" font-size="9" fill="#16a34a">• Clip portals to view cone</text>

    <!-- Arrow -->
    <line x1="100" y1="185" x2="100" y2="200" stroke="#475569" stroke-width="2"/>
    <polygon points="100,205 95,195 105,195" fill="#475569"/>

    <!-- Stage 3: Sort -->
    <rect x="0" y="210" width="200" height="80" rx="8" fill="#fef3c7" stroke="#d97706" stroke-width="2"/>
    <text x="100" y="235" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#92400e">3. DEPTH SORT</text>
    <text x="100" y="252" text-anchor="middle" font-family="monospace" font-size="9" fill="#92400e">sort_render_tree()</text>
    <text x="15" y="268" font-family="system-ui, sans-serif" font-size="9" fill="#d97706">• Order: far to near</text>
    <text x="15" y="281" font-family="system-ui, sans-serif" font-size="9" fill="#d97706">• Painter's algorithm prep</text>

    <!-- Arrow -->
    <line x1="100" y1="290" x2="100" y2="305" stroke="#475569" stroke-width="2"/>
    <polygon points="100,310 95,300 105,300" fill="#475569"/>

    <!-- Stage 4: Render polygons -->
    <rect x="0" y="315" width="200" height="100" rx="8" fill="#f3e8ff" stroke="#9333ea" stroke-width="2"/>
    <text x="100" y="340" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#7e22ce">4. RENDER SURFACES</text>
    <text x="100" y="357" text-anchor="middle" font-family="monospace" font-size="9" fill="#7e22ce">render_tree()</text>
    <text x="15" y="373" font-family="system-ui, sans-serif" font-size="9" fill="#9333ea">For each polygon (far→near):</text>
    <text x="20" y="386" font-family="system-ui, sans-serif" font-size="9" fill="#9333ea">• Ceiling texture</text>
    <text x="20" y="399" font-family="system-ui, sans-serif" font-size="9" fill="#9333ea">• Wall textures</text>
    <text x="20" y="412" font-family="system-ui, sans-serif" font-size="9" fill="#9333ea">• Floor texture</text>

    <!-- Arrow -->
    <line x1="100" y1="415" x2="100" y2="430" stroke="#475569" stroke-width="2"/>
    <polygon points="100,435 95,425 105,425" fill="#475569"/>

    <!-- Stage 5: Objects -->
    <rect x="0" y="440" width="200" height="80" rx="8" fill="#fecaca" stroke="#dc2626" stroke-width="2"/>
    <text x="100" y="465" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#991b1b">5. RENDER OBJECTS</text>
    <text x="100" y="482" text-anchor="middle" font-family="monospace" font-size="9" fill="#991b1b">render_objects()</text>
    <text x="15" y="498" font-family="system-ui, sans-serif" font-size="9" fill="#dc2626">• Monsters, items, scenery</text>
    <text x="15" y="511" font-family="system-ui, sans-serif" font-size="9" fill="#dc2626">• Sorted within polygon</text>

    <!-- Arrow -->
    <line x1="100" y1="520" x2="100" y2="535" stroke="#475569" stroke-width="2"/>
    <polygon points="100,540 95,530 105,530" fill="#475569"/>

    <!-- Stage 6: HUD -->
    <rect x="0" y="545" width="200" height="70" rx="8" fill="#cffafe" stroke="#0891b2" stroke-width="2"/>
    <text x="100" y="568" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#0e7490">6. HUD OVERLAY</text>
    <text x="100" y="585" text-anchor="middle" font-family="monospace" font-size="9" fill="#0e7490">draw_interface()</text>
    <text x="15" y="601" font-family="system-ui, sans-serif" font-size="9" fill="#0891b2">• Weapon, health, ammo</text>
  </g>

  <!-- Render tree detail (right side) -->
  <g transform="translate(300, 70)">
    <text x="300" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#475569">Render Tree Construction</text>

    <!-- View cone diagram -->
    <g transform="translate(100, 30)">
      <!-- Polygons -->
      <polygon points="200,20 350,20 350,120 200,120" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
      <text x="275" y="75" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Poly B</text>

      <polygon points="50,50 200,50 200,150 50,150" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
      <text x="125" y="105" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">Poly A</text>
      <text x="125" y="118" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#1e40af">(player)</text>

      <polygon points="350,40 450,40 450,100 350,100" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
      <text x="400" y="75" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">Poly C</text>

      <!-- Player -->
      <circle cx="100" cy="100" r="6" fill="#dc2626"/>

      <!-- View cone -->
      <polygon points="100,100 380,30 380,170" fill="#fecaca" fill-opacity="0.3" stroke="#dc2626" stroke-width="1" stroke-dasharray="4,2"/>

      <!-- Portal markers -->
      <line x1="200" y1="50" x2="200" y2="120" stroke="#7c3aed" stroke-width="3"/>
      <text x="185" y="140" font-family="system-ui, sans-serif" font-size="8" fill="#7c3aed">Portal 1</text>

      <line x1="350" y1="40" x2="350" y2="100" stroke="#7c3aed" stroke-width="3"/>
      <text x="360" y="115" font-family="system-ui, sans-serif" font-size="8" fill="#7c3aed">Portal 2</text>
    </g>

    <!-- Tree structure -->
    <g transform="translate(50, 220)">
      <text x="250" y="0" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#475569">Resulting Render Order</text>

      <!-- Tree nodes -->
      <rect x="200" y="20" width="100" height="35" rx="4" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
      <text x="250" y="42" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#1e40af">Poly A (start)</text>

      <line x1="250" y1="55" x2="250" y2="70" stroke="#475569" stroke-width="2"/>
      <polygon points="250,75 245,65 255,65" fill="#475569"/>

      <rect x="200" y="80" width="100" height="35" rx="4" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
      <text x="250" y="102" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Poly B</text>

      <line x1="250" y1="115" x2="250" y2="130" stroke="#475569" stroke-width="2"/>
      <polygon points="250,135 245,125 255,125" fill="#475569"/>

      <rect x="200" y="140" width="100" height="35" rx="4" fill="#fef3c7" stroke="#d97706" stroke-width="2"/>
      <text x="250" y="162" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#92400e">Poly C</text>

      <!-- Render order note -->
      <text x="320" y="50" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Render: C → B → A</text>
      <text x="320" y="65" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">(far to near)</text>
    </g>
  </g>

  <!-- Texture mapping detail -->
  <g transform="translate(300, 440)">
    <rect x="0" y="0" width="280" height="120" rx="8" fill="#f0fdf4" stroke="#16a34a" stroke-width="2"/>
    <text x="140" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#166534">Texture Mapping</text>
    <text x="15" y="45" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Floors/Ceilings: Affine (fast)</text>
    <text x="20" y="60" font-family="monospace" font-size="9" fill="#15803d">_texture_horizontal_polygon()</text>
    <text x="15" y="80" font-family="system-ui, sans-serif" font-size="10" fill="#166534">Walls: Perspective-correct</text>
    <text x="20" y="95" font-family="monospace" font-size="9" fill="#15803d">_texture_vertical_polygon()</text>
    <text x="15" y="112" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Source: scottish_textures.c</text>
  </g>

  <!-- Clipping detail -->
  <g transform="translate(600, 440)">
    <rect x="0" y="0" width="280" height="120" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
    <text x="140" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#991b1b">Portal Clipping</text>
    <text x="15" y="45" font-family="system-ui, sans-serif" font-size="10" fill="#991b1b">Each portal narrows the view:</text>
    <text x="20" y="62" font-family="system-ui, sans-serif" font-size="9" fill="#dc2626">• left_clip, right_clip (x bounds)</text>
    <text x="20" y="77" font-family="system-ui, sans-serif" font-size="9" fill="#dc2626">• top_clip, bottom_clip (y bounds)</text>
    <text x="15" y="97" font-family="system-ui, sans-serif" font-size="10" fill="#991b1b">Nested portals: intersect clips</text>
    <text x="15" y="112" font-family="monospace" font-size="9" fill="#991b1b">clip_to_window()</text>
  </g>

  <!-- Key stats -->
  <g transform="translate(300, 580)">
    <rect x="0" y="0" width="580" height="70" rx="6" fill="#f1f5f9" stroke="#64748b" stroke-width="1"/>
    <text x="290" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#475569">Typical Frame Statistics</text>
    <text x="20" y="45" font-family="system-ui, sans-serif" font-size="10" fill="#475569">Polygons rendered: 50-100 (from 500-1000 total)</text>
    <text x="300" y="45" font-family="system-ui, sans-serif" font-size="10" fill="#475569">Objects rendered: 10-50</text>
    <text x="20" y="62" font-family="system-ui, sans-serif" font-size="10" fill="#475569">Portal depth: typically 3-8 levels</text>
    <text x="300" y="62" font-family="system-ui, sans-serif" font-size="10" fill="#475569">Target: 30 FPS (33ms/frame)</text>
  </g>

  <!-- Source reference -->
  <text x="475" y="690" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">Source: render.c — render_view(), build_render_tree(), render_tree()</text>
</svg>
